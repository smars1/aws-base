AWSTemplateFormatVersion: "2010-09-09"
Description: CloudFormation template to create an EC2 instance with SSM access and public subnet routing

Parameters:
  
  UserName:
    Type: String
    Description: User that deploys the stack
    Default: user

  EnvName:
    Type: String
    Description: Environment name
    Default: dev
    AllowedValues:
      - dev
      - prod

  InstanceType:
    Type: String
    Description: EC2 instance type
    Default: t3.micro
    AllowedValues:
      - t3.micro
      - t2.micro
      - t2.small
      - t2.medium

  SubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: Subnet where EC2 instance will be deployed
    
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC ID used by subnet

  AmiId:
    Type: String
    Description: AMI ID for the EC2 instance
    Default: ami-0fa3fe0fa7920f68e # Amazon Linux 2

Resources:

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway

  # Attach IGW to VPC
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VpcId
      InternetGatewayId: !Ref InternetGateway

  # Route Table for public subnet
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VpcId

  # Default route: 0.0.0.0/0 -> IGW
  DefaultRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  # Associate route table with subnet
  RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref SubnetId
      RouteTableId: !Ref PublicRouteTable

  # IAM role for SSM
  EC2SSMRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "ec2-ssm-role-${EnvName}-${UserName}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy

  # Instance profile needed by EC2
  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2SSMRole

  # Security group without inbound rules
  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: SG without inbound or outbound rules, only SSM
      VpcId: !Ref VpcId

  # EC2 instance with SSM
  MyEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      ImageId: !Ref AmiId
      IamInstanceProfile: !Ref EC2InstanceProfile
      NetworkInterfaces:
        - DeviceIndex: 0
          SubnetId: !Ref SubnetId
          AssociatePublicIpAddress: true
          GroupSet:
            - !Ref InstanceSecurityGroup
      Tags:
        - Key: Name
          Value: !Sub "MyEC2Instance-${EnvName}-${UserName}"

Outputs:

  MyEC2InstanceId:
    Description: EC2 instance ID
    Value: !Ref MyEC2Instance

  EC2InstancePublicIP:
    Description: Public IP of EC2 instance
    Value: !GetAtt MyEC2Instance.PublicIp

  SSMCommand:
    Description: SSM command to connect to instance
    Value: !Sub "aws ssm start-session --target ${MyEC2Instance}"
